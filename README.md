# .NET Core SensorAPI
Simple REST Web API server written in C# with the following features:
- .NET Core Framework on amd64 Linux OS platform,
- Kestrel ASP . NET web server with MVC framework,
- PostgreSQL database accessed via EntityFramework.

The intended use case for this server is to provide a simple, universal storage API for Mobile or IoT sensors (temperature, humidity, location, etc.). This is just a proof-of-concept lacking authentication, encryption and other production-use requirements.
The development was done exclusively in Linux OS with Visual Studio Code as the main IDE.
Installation and other instructions are intended for Debian/Ubuntu flavored Linux distributions.

## Requirements - installation

1. Download and install .NET Core Framework from [Microsoft's site](https://dotnet.microsoft.com/learn/dotnet/hello-world-tutorial/install). Check that everything is ok by using the following shell command:
```sh
$ dotnet --info
.NET Core SDK (reflecting any global.json):
 Version:   2.2.300
 Commit:    73efd5bd87
 ...
 ```

2. Install PostgreSQL database server and create application user and database by executing the following commands (note that you have to select the password):
```sh
$ sudo apt install postgresql
$ sudo -iu postgres
$ createuser --interactive
Enter name of role to add: sensorapi
Shall the new role be a superuser? (y/n) y
$ psql
psql (x.x.x)
Type "help" for help.

postgres=# alter user sensorapi password '<password>';
ALTER ROLE
postgres=# \q
$ createdb sensorapi --owner sensorapi
$ Ctrl-D
```

3. Clone this repository to the local machine and install additional PostgreSQL/Swagger NuGet packages by executing the following commands:
```sh
$ mkdir -p src; cd src
$ git clone https://github.com/nekitamo/sensorapi.git
$ cd sensorapi
$ dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL # add --version to match .NET framework
$ dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL.Design
$ dotnet add package Swashbuckle.AspNetCore # Swagger support
```

4. Edit the database password entry in appsettings.json and appsettings.Development.json (use sensorapi password from step 2). Before the first startup, the database is empty and has to be initialized. The following commands will create initial EntityFramework model bindings and set the database (check that you're in sensorapi directory created in previous step):
```sh
$ dotnet ef migrations add initial
$ dotnet ef database update
```

5. Download and install Visual Studio Code from [here](https://code.visualstudio.com/). Start it, add Microsoft's C# extension and open the SensorAPI folder created in step 3 (i.e. ~/src/sensorapi). Start debugging by pressing F5...

## API Specification

The API and database schema are pretty simple - Nodes have Sensors that store Values. The relevant objects are defined in **Models/SensorContext.cs** class and web API logic is defined in **Controllers/SensorController.cs** class. The API server is automatically initialized as the first node with the default CPU temperature sensor and its measurement values can be uploaded by executing the shell script **test/sensor.sh**.

### NODES
|METHOD|ROUTE|DESCRIPTION|
|------|-----|-----------|
|GET|/api/nodes|lists all nodes from the database|
|GET|/api/nodes/1|lists the node with id=1 from the database|
|POST|/api/nodes|creates a new node from POST dataw|
|PUT|/api/nodes/1|updates the existing node with id=1|
|DELETE|/api/nodes/1|deletes the node with id=1 from the database|

### SENSORS
|METHOD|ROUTE|DESCRIPTION|
|------|-----|-----------|
|GET|/api/sensors|lists all sensors from the database|
|GET|/api/sensors/1|lists the sensor with id=1 from the database|
|POST|/api/sensors|creates a new sensor from POST data|
|PUT|/api/sensors/1|updates the existing sensor with id=1|
|DELETE|/api/sensors/1|deletes the sensor with id=1 from the database|

### VALUES
|METHOD|ROUTE|DESCRIPTION|
|------|-----|-----------|
|GET|/api/values|lists all values from the database|
|GET|/api/values/1|lists all values from sensor with id=1|
|POST|/api/values|creates a new value record in the database|

## Client specification via Swagger

Autogenerated API documentation is available (in development mode) via built-in Swagger generator at the URL http://localhost:5000/swagger. It exposes the full specification file http://localhost:5000/swagger/v1/swagger.json which can be further converted into client API code for various programming languages. This is also supported in MS Visual Studio by simply adding a "REST API client" to any project and importing the relevant swagger.json file. The archive **test/ClientGUI.tar.gz** contains one such VS project with a simple Windows GUI client built with the help of the sample **test/sensorapi-swagger.json** file.
